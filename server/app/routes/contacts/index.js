'use strict';
var router = require('express').Router();
module.exports = router;
var _ = require('lodash');
var nodemailer = require('nodemailer');

var multiparty = require('multiparty');
var multer = require('multer');

var storage = multer.diskStorage({
  destination: function(req, file, cb) {
    cb(null, './public/uploads/')
  },
  filename: function(req, file, cb) {
    cb(null, file.fieldname + '-' + Date.now() + '.csv')
  }
});

var upload = multer({
  storage: storage
});

router.get('/sendEmail', function(req, res, next) {
  res.writeHead(200, {
    'content-type': 'text/html'
  });
  res.end(
    '<form action="send" enctype="multipart/form-data" method="post">' +
    '<input type="file" name="upload"><br>' +
    '<input type="text" name="subject"><br>' +
    '<input type="text" name="html"><br>' +
    '<input type="submit" value="Upload">' +
    '</form>'
  );
});

router.post('/send', upload.single('upload'), function(req, res, next) {
	var fs = require('fs');
	var parse = require('csv-parse');
	var parser = parse({delimiter: ',', rowDelimiter:';'}, function(err, data){
	  	var transporter = nodemailer.createTransport({
			service: 'Gmail',
			auth: {
				user: '2nd.bottom.line@gmail.com',
				pass: 'CityLightC@pital'
			}
		});
		console.log(JSON.parse(req.body.data)["userid"]);
	  	for (var i=0; i<data.length; i++) {
			var mailOptions = {
				from: 'Impact Loop <2nd.bottom.line@gmail.com>',
				to: data[i][0],
				subject: JSON.parse(req.body.data)["subject"],
				text: 'Test Email',
				html: "<!DOCTYPE html><!-- saved from url=(0272)https://mail.google.com/mail/u/0/?ui=2&view=btop&ver=dqujp3h61mgd&q=cornell%20tech%20loopfeed&qs=true&search=query&th=150956ba81b4a2d1&qt=cornell.1.cornell%27s.1.feed.1.loop.1.loopfeed.1.loopfeeding.1.loopfeeds.1.tec.1.tech.1.technical.1.technologies.1.technology.1&cvid=1 --><html class=\"aAX\"><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style type=\"text/css\"></style><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" style=\"border-collapse:collapse;height:100%;margin:0;padding:0;width:100%;background-color:#f2f2f2\">            <tbody><tr>                <td align=\"center\" valign=\"top\" style=\"height:100%;margin:0;padding:0;width:100%;border-top:5px solid #ffffff\">                                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">                            <tbody><tr>                                <td align=\"center\" valign=\"top\">                                                                        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse;background-color:#f2f2f2;border-top:0;border-bottom:0\">                                        <tbody><tr>                                        <td align=\"center\" valign=\"top\">                                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" style=\"border-collapse:collapse\">                                                    <tbody><tr>                                                        <td valign=\"top\" style=\"padding-top:10px;padding-bottom:10px\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;border-collapse:collapse;table-layout:fixed!important\">    <tbody>        <tr>            <td style=\"min-width:100%;padding:18px\">                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;border-collapse:collapse\">                    <tbody><tr>                        <td>                            <span></span>                        </td>                    </tr>                </tbody></table>            </td>        </tr>    </tbody></table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;border-collapse:collapse\">    <tbody>            <tr>                <td valign=\"top\" style=\"padding:0px\">                    <table align=\"left\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"min-width:100%;border-collapse:collapse\">                        <tbody><tr>                            <td valign=\"top\" style=\"padding-right:0px;padding-left:0px;padding-top:0;padding-bottom:0;text-align:center\">                                        <img align=\"center\" alt=\"\" src=\"https://ci4.googleusercontent.com/proxy/Vb2psu6oMBbOZnhO7onQPpZMBBNHMWxoqziAqmwk9RVAsF_Cj1g2yoYVI1YDcrLg8gYTw7qncrwN86Dy5Qc6mDhFOlkZT0euPS_ue3l3FNVtQdvrymnTH1CtWFUDUzCQDR6uclc3Ggp23jI-vR-LdZtdMM0T32TiTKINpCQ=s0-d-e1-ft#https://gallery.mailchimp.com/e804a7cfba87b4737adbaa30c/images/07939072-58e1-437a-a110-9bdc250876af.png\" width=\"140\" style=\"max-width:140px;padding-bottom:0;display:inline!important;vertical-align:bottom;border:0;min-height:auto;outline:none;text-decoration:none\" class=\"CToWUd\">                            </td>                        </tr>                    </tbody></table>                </td>            </tr>    </tbody></table></td>                                                    </tr>                                                </tbody></table>                                            </td>                                        </tr>                                    </tbody></table>                                                                    </td>                            </tr>                            <tr>                            <td align=\"center\" valign=\"top\">                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse;background-color:#f2f2f2;border-top:0;border-bottom:0\">                                    <tbody><tr>                                        <td align=\"center\" valign=\"top\" style=\"padding-top:20px;padding-bottom:20px\">                                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" style=\"border-collapse:collapse\"><tbody><tr><td align=\"center\" height=\"10\" valign=\"top\" width=\"10\"><img src=\"https://ci3.googleusercontent.com/proxy/ylUi9jev3rBenA35B_N8MYMan6cpvoPYYkW9PIfPUeogBwfqnykcj6wj4X2D4sQ6cdp43J2ACqryVCnrMCAVXEXIahQ0Nl3YouIKqkt7XGVGdWYzdTjA0BxBILEYfBf0JHAxDoMtxBmCXAJd6sefHLjsyk_udFvPjHoHJaE=s0-d-e1-ft#https://gallery.mailchimp.com/27aac8a65e64c994c4416d6b8/images/d4042106-8117-4b79-b76b-91f8d64c5dff.gif\" height=\"10\" width=\"10\" style=\"display:block;line-height:0px;border:0;min-height:auto;outline:none;text-decoration:none\" class=\"CToWUd\"></td><td align=\"center\" height=\"10\" valign=\"top\" style=\"background-color:#3071b8\"><img src=\"https://ci4.googleusercontent.com/proxy/8CctGrmFevRsiC9XhIlPTQShiuNCJjDo-8mF3pH-buYmvGvLQY7RzTvcmukSYcX1p2gXIYwejUkoJum99pGzbtl3n7K7xVUQ3nAj9NTkIgZ1nRPn-ofiOwu-nOpBh0Naa_zRqrYtss2CYeC35ekA4mLD4sHyZL0wrAmAsow=s0-d-e1-ft#https://gallery.mailchimp.com/27aac8a65e64c994c4416d6b8/images/640a7ee0-db88-4905-a550-89e571c94697.png\" height=\"10\" width=\"580\" style=\"display:block;line-height:0px;border:0;min-height:auto;outline:none;text-decoration:none;vertical-align:bottom\" class=\"CToWUd\"></td><td align=\"center\" height=\"10\" valign=\"top\" width=\"10\"><img src=\"https://ci3.googleusercontent.com/proxy/ylUi9jev3rBenA35B_N8MYMan6cpvoPYYkW9PIfPUeogBwfqnykcj6wj4X2D4sQ6cdp43J2ACqryVCnrMCAVXEXIahQ0Nl3YouIKqkt7XGVGdWYzdTjA0BxBILEYfBf0JHAxDoMtxBmCXAJd6sefHLjsyk_udFvPjHoHJaE=s0-d-e1-ft#https://gallery.mailchimp.com/27aac8a65e64c994c4416d6b8/images/d4042106-8117-4b79-b76b-91f8d64c5dff.gif\" height=\"10\" width=\"10\" style=\"display:block;line-height:0px;border:0;min-height:auto;outline:none;text-decoration:none\" class=\"CToWUd\"></td></tr>                                                <tr>                                                    <td align=\"center\" colspan=\"3\" valign=\"top\">                                                        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse;background-color:#3071b8;border-bottom:2px solid #4072bd\">                                                                <tbody><tr>                                                                    <td align=\"center\" valign=\"top\">                                                                                                                                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">                                                                            <tbody><tr>                                                                                <td valign=\"top\" style=\"padding-top:20px;padding-bottom:20px\"><span class=\"im\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">    <tbody>        <tr>            <td valign=\"top\">                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">                    <tbody><tr>                        <td valign=\"top\" style=\"padding-top:9px;padding-right:18px;padding-bottom:9px;padding-left:18px;word-break:break-word;color:#ffffff;font-family:Helvetica;font-size:14px;line-height:150%;text-align:left\">                            <h1 style=\"display:block;margin:0;padding:0;font-family:Helvetica;font-size:24px;font-style:normal;font-weight:bold;line-height:125%;letter-spacing:normal;text-align:left;color:#ffffff!important\">Hello &amp; bonjour "+data[i][1]+",</h1>                        </td>                    </tr>                </tbody></table>            </td>        </tr>    </tbody></table></span><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">    <tbody>        <tr>            <td valign=\"top\">                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">                    <tbody><tr>                        <td valign=\"top\" style=\"padding-top:9px;padding-right:18px;padding-bottom:9px;padding-left:18px;word-break:break-word;color:#ffffff;font-family:Helvetica;font-size:14px;line-height:150%;text-align:left\">As a member of the <span class=\"il\">"+JSON.parse(req.body.data)["username"]+"</span> community your input is invaluable to our mission of "+JSON.parse(req.body.data)["html"]+". <br> Your story makes our story have real meaning. Please take one minute to help us out.<br>&nbsp;                        </td>                    </tr>                </tbody></table>            </td>        </tr>    </tbody></table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse\">    <tbody>        <tr>            <td style=\"padding-top:0;padding-right:18px;padding-bottom:18px;padding-left:18px\" valign=\"top\" align=\"center\">                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:separate!important;border:2px solid #f2f2f2;border-radius:4px;background-color:#ffffff\">                    <tbody>                        <tr>                            <td align=\"center\" valign=\"middle\" style=\"font-family:Arial;font-size:16px;padding:14px\">                                <a title=\"SHARE YOUR STORY\" href=\"http://localhost:8080/company/"+JSON.parse(req.body.data)["userid"]+"/write\" style=\"font-weight:bold;letter-spacing:normal;line-height:100%;text-align:center;text-decoration:none;color:#3071b8;display:block\" target=\"_blank\">SHARE YOUR STORY</a>                            </td>                        </tr>                    </tbody>                </table>            </td>        </tr>    </tbody></table></td>                                                                            </tr>                                                                        </tbody></table>                                                                                                                                            </td>                                                                </tr>                                                            </tbody></table>                                                        </td>                                                    </tr>                                                </tbody></table></td></tr></tbody></table></td></tr>                            <tr>                                <td align=\"center\" valign=\"top\">                                                                                                      </td>                            </tr>                            <tr>                                <td align=\"center\" valign=\"top\" style=\"padding-bottom:40px\">                                                                        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse:collapse;background-color:#f2f2f2;border-top:0;border-bottom:0\">                                        <tbody><tr>                                            <td align=\"center\" valign=\"top\">                                                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" style=\"border-collapse:collapse\">                                                    <tbody><tr>                                                        <td valign=\"top\" style=\"padding-top:10px;padding-bottom:10px\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;border-collapse:collapse;table-layout:fixed!important\">    <tbody>        <tr>            <td style=\"min-width:100%;padding:18px\">                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;border-top-width:1px;border-top-style:solid;border-top-color:#aaaaaa;border-collapse:collapse\">                    <tbody><tr>                        <td>                            <span></span>                        </td>                    </tr>                </tbody></table>            </td>        </tr>    </tbody>                                                    </tr>                                                </tbody></table>                                            </td>                                        </tr>                                    </tbody></table>                                                                    </td>                            </tr></tbody></table>                    </td>                </tr>            </tbody></table></html>"
			};

			transporter.sendMail(mailOptions, function(error, info) {
				if (error) {
					console.log(error);
					res.redirect('/');
				}
			});
		}
	});
	fs.createReadStream(__dirname+'/../../../../public/'+req.file.path.substring(7)).pipe(parser);
});